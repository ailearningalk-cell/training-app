<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Today's Programs</title>
<link rel="stylesheet" href="style.css">
<style>
/* Use homepage background */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(180deg, #3acfd5, #3a4ed5);
  min-height: 100vh;
  padding: 20px;
  box-sizing: border-box;
  color: #fff;
}

/* Back button same as homepage */
.back-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  font-size: 24px;
  color: white;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.2);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  z-index: 10;
  text-decoration: none;
}
.back-btn:hover {
  transform: scale(1.1);
  background: rgba(255, 255, 255, 0.3);
}

.page-container {
  max-width: 900px;
  margin: 80px auto 0; /* space for back button */
  background: rgba(255,255,255,0.05);
  border-radius: 20px;
  padding: 20px;
}

#dateLine {
  text-align: center;
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 20px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* Table styling */
table {
  width: 100%;
  border-collapse: collapse;
  display: none;
  background: rgba(255,255,255,0.1);
  color: #fff;
  border-radius: 10px;
}
thead th {
  border: 1px solid #fff;
  padding: 10px;
  text-align: left;
}
tbody td {
  border: 1px solid #fff;
  padding: 10px;
}
tbody tr:nth-child(even) {
  background: rgba(255,255,255,0.05);
}

/* No training message */
#noData {
  display: none;
  text-align: center;
  font-weight: bold;
  color: #ff0000;
  font-size: 18px;
  padding: 20px;
}

.loading {
  text-align: center;
  font-size: 16px;
  padding: 20px;
  color: #fff;
}
</style>
</head>
<body>

<a href="index.html" class="back-btn">&#8592;</a>

<div class="page-container">
  <div id="dateLine">Loading...</div>
  <div id="contentArea">
    <div id="loading" class="loading">Loadingâ€¦</div>
    <table id="programsTable"></table>
    <div id="noData">There is no training</div>
  </div>
</div>

<!-- PapaParse for robust CSV parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9rXqiV3oCIIuwRc1nXgwJ4DbYvtwsEAsPAbxUPWwzf_VYGnyJAhCL4TWn4LYs5TiDo13foTLTpY_g/pub?gid=1229350699&single=true&output=csv";
const AUTO_REFRESH_MS = 90000; // 90 sec

function norm(s){return String(s||"").replace(/\u00A0/g,' ').trim();}

function parseSheetDate(s){
  if(!s) return null;
  const parts = s.split('-');
  const dd = parseInt(parts[0],10);
  const mmm = parts[1];
  const yy = parseInt(parts[2],10);
  const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  const m = months[mmm]!==undefined ? months[mmm] : (parseInt(mmm,10)-1);
  const year = 2000 + yy;
  return new Date(year,m,dd);
}
function weekdayName(d){return d? d.toLocaleDateString('en-GB',{weekday:'long'}):'';}

function showLoading(){document.getElementById('loading').style.display='block'; document.getElementById('programsTable').style.display='none'; document.getElementById('noData').style.display='none';}
function showNoData(msg){document.getElementById('loading').style.display='none'; document.getElementById('programsTable').style.display='none'; let el=document.getElementById('noData'); el.textContent=msg; el.style.display='block';}
function showTable(html){document.getElementById('loading').style.display='none'; document.getElementById('noData').style.display='none'; let el=document.getElementById('programsTable'); el.innerHTML=html; el.style.display='table';}

function findHeaderRow(rows){
  for(let i=0;i<Math.min(rows.length,20);i++){
    const lc=rows[i].map(c=>norm(c).toLowerCase());
    if(lc.includes('day') && (lc.includes('name') || lc.includes('training'))) return i;
  }
  return -1;
}

function loadTable(){
  showLoading();
  const url = CSV_URL + "&_=" + Date.now();
  console.log("Fetching CSV:",url);

  Papa.parse(url,{download:true,header:false,skipEmptyLines:false,
    complete: function(res){
      try{
        const rawRows=(res.data||[]).map(r=>r.map(c=>norm(c)));
        console.log("Parsed Rows (first 20):", rawRows.slice(0,20));

        const topDate = rawRows[0]&&rawRows[0][0]?rawRows[0][0]:'';
        const parsedDate=parseSheetDate(topDate);
        let wd=weekdayName(parsedDate);
        document.getElementById('dateLine').textContent=parsedDate?`Today: ${topDate} [${wd}]`:'Today';

        const headerIdx=findHeaderRow(rawRows);
        if(headerIdx===-1){showNoData("Sheet missing header row");return;}
        const headers=rawRows[headerIdx];
        const dataRows=rawRows.slice(headerIdx+1).filter(r=>r.some(c=>c!==""));

        if(!dataRows.length || (dataRows[0][0].toLowerCase().includes("there is no training"))){
          showNoData("There is no training");
          return;
        }

        const headerLc=headers.map(h=>norm(h).toLowerCase());
        const dayIdx = headerLc.findIndex(h=>h.includes('day'));
        const nameIdx = headerLc.findIndex(h=>h.includes('name')||h.includes('training'));
        const venueIdx = headerLc.findIndex(h=>h.includes('venue')||h.includes('place')||h.includes('location'));

        let html="<thead><tr><th>Sl. No</th><th>Day</th><th>Name of the Training</th><th>Venue</th></tr></thead><tbody>";
        dataRows.forEach((r,i)=>{
          const day=dayIdx!==-1?r[dayIdx]:'';
          const name=nameIdx!==-1?r[nameIdx]:'';
          const venue=venueIdx!==-1?r[venueIdx]:'';
          html+=`<tr><td>${i+1}</td><td>${day}</td><td>${name}</td><td>${venue}</td></tr>`;
        });
        html+="</tbody>";
        showTable(html);
      }catch(e){console.error(e); showNoData("Error processing sheet");}
    },
    error:function(e){console.error(e); showNoData("Failed to load sheet");}
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  loadTable();
  if(AUTO_REFRESH_MS>0) setInterval(loadTable,AUTO_REFRESH_MS);
});
</script>
</body>
</html>
