<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Debug — Today's Programs</title>
  <style>
    body { font-family: Arial, sans-serif; margin:18px; background:#f7fafc; color:#111 }
    h1 { margin:0 0 6px }
    pre { background:#fff; border:1px solid #e5e7eb; padding:12px; max-height:420px; overflow:auto; white-space:pre-wrap; }
    .ok { color:green; font-weight:600 }
    .warn { color:darkorange; font-weight:600 }
    .err { color:crimson; font-weight:700 }
    button { margin:6px 6px 12px 0; padding:8px 12px; }
  </style>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Debug — Today's Programs</h1>
  <p>This page will fetch your published CSV and show parsed rows + header detection + rows that match today's date.</p>

  <div>
    <button id="runBtn">Run debug</button>
    <button id="openConsoleBtn">Open browser console (F12)</button>
  </div>

  <h3>Config</h3>
  <pre id="configArea"></pre>

  <h3>Raw CSV (first 2000 chars)</h3>
  <pre id="rawCsv">—</pre>

  <h3>Parsed Rows (first 20)</h3>
  <pre id="rows">—</pre>

  <h3>Header detection</h3>
  <pre id="headerInfo">—</pre>

  <h3>Matches for today</h3>
  <pre id="matches">—</pre>

  <h3>Notes / Errors</h3>
  <pre id="notes">—</pre>

<script>
(() => {
  // === CONFIG ===
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9rXqiV3oCIIuwRc1nXgwJ4DbYvtwsEAsPAbxUPWwzf_VYGnyJAhCL4TWn4LYs5TiDo13foTLTpY_g/pub?gid=1229350699&single=true&output=csv";

  function formatSheetDate(d) {
    const dd = String(d.getDate()).padStart(2, "0");
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const mmm = months[d.getMonth()];
    const yy = String(d.getFullYear()).slice(-2);
    return `${dd}-${mmm}-${yy}`;
  }
  const todayStr = formatSheetDate(new Date());

  // UI references
  const configArea = document.getElementById("configArea");
  const rawCsvEl = document.getElementById("rawCsv");
  const rowsEl = document.getElementById("rows");
  const headerEl = document.getElementById("headerInfo");
  const matchesEl = document.getElementById("matches");
  const notesEl = document.getElementById("notes");
  const runBtn = document.getElementById("runBtn");
  const openConsoleBtn = document.getElementById("openConsoleBtn");

  configArea.textContent = `CSV_URL: ${CSV_URL}\nToday (sheet format): ${todayStr}`;

  openConsoleBtn.onclick = () => {
    alert("Press F12 (or Ctrl+Shift+I) to open the browser console. Then click Run debug.");
  };

  function normCell(c){ return String(c||"").replace(/\u00A0/g,' ').trim(); }

  function findHeaderRow(rows, maxScan=12){
    for (let i=0;i<Math.min(rows.length,maxScan);i++){
      const lc = rows[i].map(c => normCell(c).toLowerCase());
      const hasDay = lc.some(x => x === "day" || x.includes("day"));
      const hasName = lc.some(x => x.includes("name") || x.includes("training"));
      if (hasDay && hasName) return i;
    }
    return -1;
  }

  function print(o, el){
    console.log(o);
    el.textContent = typeof o === "string" ? o : JSON.stringify(o, null, 2);
  }

  async function runDebug(){
    print("Starting debug…", notesEl);
    try {
      // fetch raw CSV text (also show)
      const resp = await fetch(CSV_URL);
      if (!resp.ok) {
        print({error: "Network fetch failed", status: resp.status, statusText: resp.statusText}, notesEl);
        rawCsvEl.textContent = `Fetch failed: ${resp.status} ${resp.statusText}`;
        return;
      }
      const raw = await resp.text();
      rawCsvEl.textContent = raw.slice(0,2000) + (raw.length>2000 ? "\n…(truncated)":"");
      console.log("RAW CSV full:", raw);

      // parse with PapaParse (no header so we get raw rows)
      const parsed = Papa.parse(raw, { header:false, skipEmptyLines:true });
      if (parsed.errors && parsed.errors.length) {
        print({ papaErrors: parsed.errors.slice(0,5) }, notesEl);
      }

      const rows = parsed.data.map(r => r.map(c => normCell(c)));
      print(rows.slice(0,20), rowsEl);

      const headerIdx = findHeaderRow(rows, 20);
      print({ headerIdx }, headerEl);

      if (headerIdx === -1) {
        print("Header not detected automatically. Showing first 12 rows above; look for where headers are.", notesEl);
        return;
      }

      const headers = rows[headerIdx].map(c => normCell(c));
      print({ headers }, headerEl);

      const dataRows = rows.slice(headerIdx+1);
      // check special "There is no training today"
      if (dataRows.length && dataRows[0][0] && dataRows[0][0].toLowerCase().includes("there is no training")) {
        print("Sheet contains fallback: 'There is no training today'", notesEl);
        matchesEl.textContent = "Sheet says: There is no training today";
        return;
      }

      const dayIdx = headers.map(h=>h.toLowerCase()).indexOf("day");
      const nameIdx = headers.map(h=>h.toLowerCase()).findIndex(h=> h.includes("name") || h.includes("training"));
      const venueIdx = headers.map(h=>h.toLowerCase()).findIndex(h=> h.includes("venue"));

      print({ dayIdx, nameIdx, venueIdx }, headerEl);

      if (dayIdx === -1 || nameIdx === -1) {
        print("Required columns not found (Day + Name). See headers above.", notesEl);
        return;
      }

      const todays = dataRows.filter(r => String(r[dayIdx]||"").trim() === todayStr);
      print({ todaysCount: todays.length }, matchesEl);

      if (!todays.length) {
        matchesEl.textContent = `No rows match today's date (${todayStr}).\n\nFirst 12 data rows:\n` + JSON.stringify(dataRows.slice(0,12),null,2);
        return;
      }

      // show matched rows
      const shown = todays.map((r,i)=>({
        "Sl.No": i+1,
        Day: r[dayIdx],
        Name: r[nameIdx],
        Venue: (venueIdx!==-1? r[venueIdx] : "")
      }));
      print(shown, matchesEl);
      notesEl.textContent = "Success — matched rows shown above.";
    } catch (err) {
      print({ error: String(err) }, notesEl);
    }
  }

  runBtn.onclick = runDebug;
})();
</script>
</body>
</html>

